
# ÔøΩÔøΩ **B√ÅO C√ÅO CHI TI·∫æT V·∫§N ƒê·ªÄ GROQ API KEY**

## 1. ÔøΩÔøΩ **V·∫§N ƒê·ªÄ**

### **Tri·ªáu ch·ª©ng:**
- ‚úÖ **Environment variables load th√†nh c√¥ng** t·ª´ settings.py
- ‚úÖ **GROQ client initialized successfully** 
- ‚ùå **GROQ API calls b·ªã l·ªói 401 Unauthorized** khi th·ª±c thi
- ‚úÖ **OPENAI API ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng**

### **L·ªói c·ª• th·ªÉ:**
```
HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 401 Unauthorized"
Groq API error: Error code: 401 - {'error': {'message': 'Invalid API Key', 'type': 'invalid_request_error', 'code': 'invalid_api_key'}}
```

---

## 2. üîç **NGUY√äN NH√ÇN**

### **A. V·∫•n ƒë·ªÅ ch√≠nh: Environment Variables Priority**

**Pydantic Settings c√≥ th·ª© t·ª± ∆∞u ti√™n:**
1. **System Environment Variables** (cao nh·∫•t) ‚ö†Ô∏è
2. **File .env** (th·∫•p nh·∫•t)

### **B. GROQ_API_KEY c≈© ƒë∆∞·ª£c set trong System Environment**

**Ki·ªÉm tra cho th·∫•y:**
```powershell
Name                           Value
----                           -----
GROQ_API_KEY                   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
```

**Key c≈© n√†y:**
- ‚ùå **ƒê√£ expired ho·∫∑c invalid**
- ‚ùå **ƒê∆∞·ª£c set t·ª´ l·∫ßn ch·∫°y tr∆∞·ªõc** (c√≥ th·ªÉ t·ª´ file `deploy/src/main.py`)
- ‚ùå **Override file .env m·ªõi**

### **C. T·∫°i sao OPENAI kh√¥ng b·ªã v·∫•n ƒë·ªÅ n√†y?**

**L√Ω do:**
1. **OPENAI_API_KEY ch∆∞a ƒë∆∞·ª£c set** trong system environment variables
2. **Ch·ªâ c√≥ GROQ_API_KEY** ƒë∆∞·ª£c set c≈© trong environment
3. **Pydantic load OPENAI_API_KEY t·ª´ file .env** (v√¨ kh√¥ng c√≥ trong environment)
4. **Pydantic load GROQ_API_KEY t·ª´ environment** (v√¨ c√≥ s·∫µn, ∆∞u ti√™n cao h∆°n)

### **D. Ngu·ªìn g·ªëc GROQ_API_KEY c≈©**

**File `deploy/src/main.py` (d√≤ng 32-37):**
```python
# Check environment variable before loading .env
print(f"GROQ_API_KEY before load_dotenv: {os.getenv('GROQ_API_KEY')[0:10]}")

load_dotenv(dotenv_path=env_path, override=True)

# Check environment variable after loading .env
print(f"GROQ_API_KEY after load_dotenv: {os.getenv('GROQ_API_KEY')[0:10]}")

# Groq client - Load API key from environment
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
```

**File n√†y ƒë√£ ch·∫°y tr∆∞·ªõc ƒë√≥ v√† set GROQ_API_KEY v√†o system environment.**

---

## 3. üõ†Ô∏è **GI·∫¢I PH√ÅP**

### **A. Gi·∫£i ph√°p t·ª©c th√¨ (ƒê√£ th·ª±c hi·ªán)**

1. **X√≥a environment variable c≈©:**
   ```powershell
   Remove-Item Env:GROQ_API_KEY
   ```

2. **Force load t·ª´ .env file:**
   ```python
   # Trong settings.py
   from dotenv import load_dotenv
   load_dotenv(env_file_path, override=True)
   ```

3. **Th√™m logging chi ti·∫øt:**
   ```python
   logger.info(f"GROQ_API_KEY from os.getenv: {os.getenv('GROQ_API_KEY', 'NOT_SET')[:10]}...")
   logger.info(f"Force loaded .env file from: {env_file_path}")
   ```

### **B. Gi·∫£i ph√°p d√†i h·∫°n**

1. **T√°ch bi·ªát environment variables:**
   - S·ª≠ d·ª•ng **prefix** cho environment variables
   - V√≠ d·ª•: `APP_GROQ_API_KEY` thay v√¨ `GROQ_API_KEY`

2. **C·∫£i thi·ªán settings.py:**
   ```python
   class Settings(BaseSettings):
       GROQ_API_KEY: str
       
       class Config:
           env_file = "../.env"
           env_file_encoding = "utf-8"
           extra = "ignore"
           # Force ignore environment variables
           case_sensitive = False
   ```

3. **Validation API keys:**
   ```python
   def validate_api_keys():
       # Test GROQ API key
       try:
           test_client = Groq(api_key=settings.GROQ_API_KEY)
           test_client.chat.completions.create(...)
       except Exception as e:
           logger.error(f"GROQ API key invalid: {e}")
   ```

### **C. Gi·∫£i ph√°p monitoring**

1. **Log API key sources:**
   ```python
   logger.info(f"GROQ_API_KEY source: {'Environment' if os.getenv('GROQ_API_KEY') else '.env file'}")
   ```

2. **Health check endpoint:**
   ```python
   @app.get("/health/groq")
   def check_groq_health():
       try:
           # Test GROQ API
           return {"status": "healthy"}
       except Exception as e:
           return {"status": "unhealthy", "error": str(e)}
   ```

---

## 4. üìä **T√ìM T·∫ÆT**

| Aspect | GROQ_API_KEY | OPENAI_API_KEY |
|--------|---------------|----------------|
| **System Env** | ‚úÖ Set (c≈©) | ‚ùå Not set |
| **File .env** | ‚úÖ Set (m·ªõi) | ‚úÖ Set (m·ªõi) |
| **Pydantic Priority** | System Env (c≈©) | File .env (m·ªõi) |
| **Result** | ‚ùå Invalid key | ‚úÖ Valid key |

**K·∫øt lu·∫≠n:** GROQ b·ªã l·ªói v√¨ **environment variable c≈© override file .env m·ªõi**, trong khi OPENAI kh√¥ng b·ªã v√¨ **kh√¥ng c√≥ environment variable c≈©**.

**Gi·∫£i ph√°p:** X√≥a environment variables c≈© + Force load t·ª´ .env file! üöÄ