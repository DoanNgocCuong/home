```
=> CACHED [intent-api 8/10] RUN pip3 install --no-cache-dir --upgrade pip && pip3 install --no-cache-dir -r /app/requi 0.0s => CACHED [intent-api 9/10] COPY src/ /app/src/ 0.0s => CACHED [intent-api 10/10] RUN mkdir -p /app/src/logs 0.0s => [intent-api] exporting to image 0.0s => => exporting layers 0.0s => => writing image sha256:f82813ab1604d9c58868f6d27b9ac37fdf15a01eb3c227088b45a42362d255f4 0.0s => => naming to docker.io/library/miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation-intent-api 0.0s [+] Running 1/0 ✘ Network miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network Error 0.0s failed to create network miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network: Error response from daemon: could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network θ73° [ubuntu@mgc-dev2-3090:~/truc_ai/MiniProd_NLP2_IntentClassification_MappingFastResponse_T1_2025_StepUpEducation/src] master(+10/-4)* ± Lỗi gì đây nhỉ
```

Nguyên nhân và cách xử lý

- Lỗi: Docker không tạo được network vì “could not find an available, non-overlapping IPv4 address pool among the defaults…”. Nghĩa là dải IP mặc định của Docker (IPAM) đã hết slot hoặc bị trùng với route hiện có (thường do VPN, nhiều network cũ còn tồn tại, hoặc cấu hình IP trùng).

Cách khắc phục nhanh (chọn 1 trong các cách sau)

1) Dọn mạng Docker cũ rồi chạy lại
- Xem các network hiện có:
```bash
docker network ls
```
- Xóa các network không dùng (cẩn thận: sẽ xóa tất cả network không gắn container):
```bash
docker network prune
```
- Hoặc xóa đúng network của project (nếu tồn tại):
```bash
docker network rm miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network
```
- Khởi động lại Docker:
```bash
sudo systemctl restart docker
```
- Chạy lại docker compose.

2) Chỉ định subnet riêng trong docker-compose để tránh trùng
- Trong `docker-compose.yml`, đặt subnet khác hẳn VPN/host (ví dụ 172.30.0.0/24):
```yaml
networks:
  intent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
```
- Nếu vẫn trùng, đổi sang 172.31.0.0/24 hoặc 10.99.0.0/24,…

3) Mở rộng “default-address-pools” của Docker daemon
- Tạo/sửa [/etc/docker/daemon.json](cci:7://file:///etc/docker/daemon.json:0:0-0:0):
```json
{
  "default-address-pools": [
    { "base": "172.17.0.0/12", "size": 24 },
    { "base": "10.0.0.0/8",     "size": 24 }
  ]
}
```
- Sau đó:
```bash
sudo systemctl restart docker
```
- Cách này giúp Docker có nhiều pool địa chỉ, giảm khả năng trùng.

Gợi ý kiểm tra trùng dải IP
- Kiểm tra route hiện tại (đặc biệt khi bật VPN):
```bash
ip route
```
- Nếu thấy các dải 172.17/16, 172.18/16, 172.19/16, 10.x/8 đang dùng, chọn subnet Docker tránh những dải đó.

Bạn muốn mình sửa ngay `docker-compose.yml` để đặt subnet cố định cho `intent-network`, hay thử dọn network (prune) trước cho nhanh?


---
# Docker Network Issues Report

## 1. Vấn đề gặp phải

### Lỗi chính

```
failed to create network miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network: 
Error response from daemon: could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network
```

### Triệu chứng

- Docker Compose không thể tạo custom network mới
- Container build thành công nhưng không thể start do lỗi network
- Lỗi xảy ra liên tục dù đã thử docker network prune

### Nguyên nhân gốc rễ

Docker daemon đã cạn kiệt các dải IP khả dụng do có quá nhiều networks đang tồn tại trên hệ thống.

## 2. Kiểm tra các mạng hiện tại

### Network inventory

Hệ thống hiện có **30+ Docker networks** đang hoạt động:

```bash
$ docker network ls
NETWORK ID     NAME                                                                   DRIVER    SCOPE
1ee83a85e17e   ai-agent-coach_robot-ai-workflow-network-master                        bridge    local
01684692a642   ai-agent-master_robot-ai-workflow-network-master                       bridge    local
22a276825d4a   ai-agent-noti_robot-ai-workflow-network-master                         bridge    local
b4815173bfb5   ai-agent-router-dev_robot-ai-workflow-network-master                   bridge    local
# ... và 25+ networks khác
```

### IP Range Analysis

Từ `ip route` output, các dải IP đang được sử dụng:

**172.x.x.x networks:**

- 172.17.0.0/16 (docker0 - default bridge)
- 172.18.0.0/16 đến 172.31.0.0/16 (14 networks)

**192.168.x.x networks:**

- 192.168.0.0/20 đến 192.168.240.0/20 (16 networks)

**170.x.x.x networks:**

- 170.26.0.0/24, 170.28.0.0/24

**Tổng cộng: 32 active networks** sử dụng hầu hết các dải IP mặc định của Docker.

## 3. Giải pháp được áp dụng

### Bước 1: Cleanup cơ bản

```bash
# Thử dọn dẹp networks không sử dụng
docker network prune -f
# Kết quả: Không có network nào bị xóa (tất cả đều đang được sử dụng)
```

### Bước 2: Chỉnh sửa Network Configuration

#### Docker Compose Configuration mới:

```yaml
version: '3.8'

services:
  intent-api:
    build: .
    container_name: intent-classification-api
    ports:
      - "20012:20012"
    env_file:
      - .env
    volumes:
      # Model persistence
      - ./src/exported_models:/app/src/exported_models
      - ./src/trained_models:/app/src/trained_models
      # Response files
      - ./src/intent_reponse.json:/app/src/intent_reponse.json
      - ./src/intent_reponse_v2.json:/app/src/intent_reponse_v2.json
      - ./src/fixed_response.json:/app/src/fixed_response.json
      # Logs
      - ./logs:/app/src/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:20012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    runtime: nvidia
    networks:
      - intent-network

networks:
  intent-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.0.0/24
          gateway: 10.10.0.1
```

## 5. Khuyến nghị cho tương lai

### Monitoring và Maintenance

1. **Định kỳ dọn dẹp networks**:
    
    ```bash
    docker network prune -f
    docker system prune -f
    ```
    
2. **Sử dụng subnet cụ thể** trong docker-compose để tránh xung đột:
    
    ```yaml
    networks:
      app-network:
        ipam:
          config:
            - subnet: 10.x.0.0/24  # Chọn dải IP chưa sử dụng
    ```
    
3. **Giới hạn số lượng projects** chạy đồng thời trên server
    

### Best Practices

- Sử dụng project names ngắn gọn để tránh tên network quá dài
- Cân nhắc sử dụng external networks cho các services liên quan
- Monitor Docker daemon resources và network usage
- Implement proper cleanup trong CI/CD pipelines

### Warning Đã giải quyết

```
! intent-api Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.
```

Đây là warning không ảnh hưởng đến hoạt động của container, chỉ thông báo về giới hạn swap memory.

## 6. Tóm tắt

**Vấn đề**: Docker network IP pool exhaustion  
**Nguyên nhân**: 30+ active networks sử dụng hết dải IP mặc định  
**Giải pháp**: Sử dụng custom subnet hoặc cleanup aggressive  
**Kết quả**: Container chạy thành công, API hoạt động ổn định  
**Lesson learned**: Cần monitoring và cleanup định kỳ Docker resources